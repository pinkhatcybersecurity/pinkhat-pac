version: 1.0
policies:
  - module: aws_db_instance
    category: "terraform"
    rules:
      - name: "Maintenance Window for OS patching"
        link: "aws_db_instance"
        description: >
          Not all patches and security fixes are automatically implemented in a database.
          The required work must be implemented during the maintenance window.
          https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.Maintenance.html#OS_Updates
        remediation: >
          Provide maintenance window based on your needs

          resource "aws_db_instance" "db_instance_name" {
            ...
            maintenance_window          = "Mon:00:00-Mon:03:00"
          }
        statement: "this.object.get('maintenance_window') is not none"
      - name: "Publicly accessible database"
        link: "aws_db_instance"
        description: >
          Publicly accessible database might lead to data leakage through:

            - security vulnerability in the database
            - default user name and password
            - weak passwords
            - and more

          Database should be hidden and not accessible via internet.

          https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance#publicly_accessible

          publicly_accessible - default value is false
        remediation: >
          Disable publicly_accessible in aws_db_instance

          resource "aws_db_instance" "db_instance_name" {
            ...
            publicly_accessible = false
          }
        statement: "this.object.get('publicly_accessible', false) is false"
      - name: "Backup retention policy"
        link: "aws_db_instance"
        description: >
          Data recovery is a key aspect for the application availability.
          Backup retention period in aws_db_instance defines for how long backup is stored.
          The value is between 0 and 35 days. You can find more information in the link below:

          https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance#backup_retention_period
        remediation: >
          Create a backup retention policy for aws_db_instance greater than 0

          resource "aws_db_instance" "db_instance_name" {
            ...
            backup_retention_period = 1
          }
        statement: "this.object.get('backup_retention_period', 0) > 1"
